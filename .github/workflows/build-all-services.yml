# =============================================================
# GitHub Actions Workflow para Microservicios ToolRent
# =============================================================
# Este workflow construye y sube todas las im√°genes Docker
# a Docker Hub cuando se hace push a main/master.
# =============================================================

name: Build and Push All Services

# ¬øCu√°ndo se ejecuta?
on:
  push:
    branches: [main, master]
    paths:
      - 'Evaluacion 2/**'  # Solo cuando hay cambios en Evaluacion 2
  pull_request:
    branches: [main, master]
    paths:
      - 'Evaluacion 2/**'
  workflow_dispatch:  # Permite ejecuci√≥n manual desde GitHub

# Variables de entorno globales
env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # =========================================================
  # Job 1: Build de todos los Microservicios (en paralelo)
  # =========================================================
  build-microservices:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - eureka-service
          - config-service
          - gateway-service
          - inventory-service
          - clients-service
          - kardex-service
          - loans-service
          - rates-service
          - reports-service
          - users-service
      fail-fast: false  # Contin√∫a aunque uno falle

    steps:
      # Paso 1: Checkout del c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Paso 2: Configurar Docker Buildx (builds optimizados)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Paso 3: Login a Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Paso 4: Build y Push de la imagen
      - name: Build and Push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: "./Evaluacion 2/Microservices/${{ matrix.service }}"
          file: "./Evaluacion 2/Microservices/${{ matrix.service }}/Dockerfile"
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}:latest
            ${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =========================================================
  # Job 2: Build del Frontend
  # =========================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: "./Evaluacion 2/Frontend-ToolRent"
          file: "./Evaluacion 2/Frontend-ToolRent/Dockerfile"
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/frontend-toolrent:latest
            ${{ env.DOCKERHUB_USERNAME }}/frontend-toolrent:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =========================================================
  # Job 3: Resumen del Build (opcional, para notificaciones)
  # =========================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-microservices, build-frontend]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "üéâ Build completado!"
          echo "üì¶ Microservicios: ${{ needs.build-microservices.result }}"
          echo "üñ•Ô∏è Frontend: ${{ needs.build-frontend.result }}"
          
          if [ "${{ needs.build-microservices.result }}" == "failure" ] || [ "${{ needs.build-frontend.result }}" == "failure" ]; then
            echo "‚ùå Algunos builds fallaron"
            exit 1
          fi
          
          echo "‚úÖ Todos los builds exitosos!"
