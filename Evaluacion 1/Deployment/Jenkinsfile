pipeline {
    agent any
    environment {
        DOCKERHUB_USERNAME = 'bigbenj4' 
        BACKEND_IMAGE_NAME = "${env.DOCKERHUB_USERNAME}/toolrent-backend"
        FRONTEND_IMAGE_NAME = "${env.DOCKERHUB_USERNAME}/toolrent-frontend"
        IMAGE_TAG = "${env.BUILD_ID}"
        DOCKERHUB_CREDENTIALS = 'dockerhub-credentials-id' 
        SSH_CREDENTIALS = 'ssh-server-credentials-id'
        TARGET_USER = 'benjaminhernandez' 
        TARGET_HOST = '127.0.0.1'
        DEPLOY_DIR = 'deployment_toolrent'
        DOCKER_CONTEXT = "default"
    }

    stages {

        stage('Test Backend') {
            steps {
                script {
                    echo "--- Ejecutando Tests Unitarios del Backend (Modo Directo) ---"
                    // CORREGIDO: Agregado 'Evaluacion 1' a la ruta y mantenido comillas dobles
                    sh """
                        docker run --rm -v "${WORKSPACE}/Evaluacion 1/Backend-ToolRent":/app -v /root/.m2:/root/.m2 -w /app maven:3.9-eclipse-temurin-17 mvn clean test
                    """
                }
            }
        }
        
        stage('Build & Push Backend') {
            steps {
                script {
                    echo "--- Construyendo Backend con BuildKit ---"
                    // CORREGIDO: Agregado 'Evaluacion 1' a la ruta del Dockerfile y del Contexto.
                    // IMPORTANTE: Se usan comillas escapadas \"...\" porque hay espacios en el nombre de la carpeta
                    sh """
                        DOCKER_BUILDKIT=1 docker build \
                            --build-arg BUILDKIT_INLINE_CACHE=1 \
                            --cache-from ${env.BACKEND_IMAGE_NAME}:latest \
                            -t ${env.BACKEND_IMAGE_NAME}:${env.IMAGE_TAG} \
                            -t ${env.BACKEND_IMAGE_NAME}:latest \
                            -f "Evaluacion 1/Backend-ToolRent/Dockerfile" \
                            "Evaluacion 1/Backend-ToolRent"
                    """
                    
                    docker.withRegistry("https://index.docker.io/v1/", "${env.DOCKERHUB_CREDENTIALS}") {
                        sh "docker push ${env.BACKEND_IMAGE_NAME}:${env.IMAGE_TAG}"
                        sh "docker push ${env.BACKEND_IMAGE_NAME}:latest"
                    }
                }
            }
        }


        stage('Build & Push Frontend') {
            steps {
                script {
                    echo "--- Construyendo Frontend para: ${env.FRONTEND_IMAGE_NAME}:${env.IMAGE_TAG} ---"
                    // CORREGIDO: Agregado 'Evaluacion 1' a las rutas. 
                    // Se usan comillas simples dentro del string para manejar el espacio.
                    def frontendImage = docker.build("${env.FRONTEND_IMAGE_NAME}:${env.IMAGE_TAG}", "-f 'Evaluacion 1/Frontend-ToolRent/Dockerfile' 'Evaluacion 1/Frontend-ToolRent'")
                    
                    docker.withRegistry("https://index.docker.io/v1/", "${env.DOCKERHUB_CREDENTIALS}") {
                        frontendImage.push()
                        frontendImage.push("latest")
                    }
                }
            }
        }

        stage('Deploy to Production') {
            steps {
                sshagent([env.SSH_CREDENTIALS]) {
                    withCredentials([
                        string(credentialsId: 'DB_PASS', variable: 'DB_PASS'),
                        string(credentialsId: 'KEYCLOAK_ADMIN_PASS', variable: 'KEYCLOAK_ADMIN_PASS')
                    ]) {
                        script {
                            sh "ssh -o StrictHostKeyChecking=no ${env.TARGET_USER}@${env.TARGET_HOST} 'mkdir -p ${env.DEPLOY_DIR}/config/keycloak-realm'"
                            
                            // CORREGIDO: Todas las rutas de origen ahora tienen "Evaluacion 1/" al inicio
                            // y están envueltas en comillas dobles para que el shell no rompa con el espacio.
                            sh "scp \"Evaluacion 1/Deployment/docker-compose.prod.yml\" ${env.TARGET_USER}@${env.TARGET_HOST}:${env.DEPLOY_DIR}/docker-compose.yml"
                            sh "scp \"Evaluacion 1/Backend-ToolRent/nginx.conf\" ${env.TARGET_USER}@${env.TARGET_HOST}:${env.DEPLOY_DIR}/config/nginx.conf"
                            sh "scp -r \"Evaluacion 1/Backend-ToolRent/keycloak-realm/\"* ${env.TARGET_USER}@${env.TARGET_HOST}:${env.DEPLOY_DIR}/config/keycloak-realm/"

                            def env_vars = """
                                export BACKEND_IMAGE_NAME=${env.BACKEND_IMAGE_NAME}
                                export FRONTEND_IMAGE_NAME=${env.FRONTEND_IMAGE_NAME}
                                export DB_NAME=toolrentdb
                                export DB_USER=admin
                                export DB_PASS=${DB_PASS}
                                export KEYCLOAK_ADMIN_USER=admin
                                export KEYCLOAK_ADMIN_PASS=${KEYCLOAK_ADMIN_PASS}
                                export DOMAIN_NAME=localhost
                                export NGINX_CONF_PATH=./config/nginx.conf
                                export KEYCLOAK_REALM_PATH=./config/keycloak-realm
                            """

                            // Ejecutar comandos Docker en remoto
                            sh """
                                ssh -o StrictHostKeyChecking=no ${env.TARGET_USER}@${env.TARGET_HOST} '
                                    cd ${env.DEPLOY_DIR} && \\
                                    ${env_vars} \\
                                    docker compose pull && \\
                                    docker compose down --remove-orphans && \\
                                    docker compose up -d --no-build

                                    echo "--- Esperando a que Keycloak inicie para configurarlo ---"
                                    
                                    RETRIES=24
                                    COUNT=0

                                    until curl -s -f -o /dev/null "http://localhost:8080/realms/master"; do
                                        if [ \$COUNT -ge \$RETRIES ]; then
                                            echo "❌ Error: Keycloak no inició después de 2 minutos."
                                            exit 1
                                        fi
                                        echo "⏳ Esperando a Keycloak... (intento \$COUNT/\$RETRIES)"
                                        sleep 5
                                        COUNT=\$((COUNT+1))
                                    done

                                    echo "--- Aplicando parches de seguridad al Master Realm ---"
                                    docker exec toolrent-keycloak-prod /opt/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin --password ${KEYCLOAK_ADMIN_PASS}
                                    
                                    # Desactivar SSL del Master
                                    docker exec toolrent-keycloak-prod /opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=NONE
                                    
                                    # Arreglar CORS para que puedas entrar desde 127.0.0.1
                                    CID=\$(docker exec toolrent-keycloak-prod /opt/keycloak/bin/kcadm.sh get clients -r master -q clientId=security-admin-console --fields id --format csv --noquotes)
                                    docker exec toolrent-keycloak-prod /opt/keycloak/bin/kcadm.sh update clients/\$CID -r master -s "redirectUris=[\\"http://localhost:8080/*\\",\\"http://${env.TARGET_HOST}:8080/*\\"]" -s "webOrigins=[\\"+ \\"]"
                                '
                            """
                        }
                    }
                }
            }
        }
    }
}