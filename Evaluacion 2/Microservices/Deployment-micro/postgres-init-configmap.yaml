apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
data:
  init-db.sh: |
    #!/bin/bash
    set -e

    # Script para crear todas las bases de datos necesarias para los microservicios
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        -- Crear bases de datos para cada microservicio
        CREATE DATABASE loans;
        CREATE DATABASE clients;
        CREATE DATABASE users;
        CREATE DATABASE inventory;
        CREATE DATABASE kardex;
        CREATE DATABASE rates;
        CREATE DATABASE reports;
        
        -- Otorgar permisos al usuario
        GRANT ALL PRIVILEGES ON DATABASE loans TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE clients TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE users TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE inventory TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE kardex TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE rates TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE reports TO $POSTGRES_USER;
    EOSQL

    # Conectar a la base de datos "users" para crear tablas e insertar usuario inicial
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "users" <<-EOSQL
        -- Crear tabla worker si no existe
        CREATE TABLE IF NOT EXISTS worker (
            worker_id BIGSERIAL PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            mail VARCHAR(255) NOT NULL,
            password VARCHAR(255) NOT NULL,
            keycloak_id VARCHAR(255)
        );

        -- Crear tabla worker_roles si no existe
        CREATE TABLE IF NOT EXISTS worker_roles (
            worker_id BIGINT NOT NULL,
            rol VARCHAR(255),
            FOREIGN KEY (worker_id) REFERENCES worker(worker_id)
        );

        -- Insertar usuario inicial si no existe
        INSERT INTO worker (name, mail, password, keycloak_id) 
        SELECT 'Benjamin Hernandez', 'benja@gmail.com', '12345678', '91932bbe-206e-43e7-b79b-cce0800d2cdc'
        WHERE NOT EXISTS (SELECT 1 FROM worker WHERE mail = 'benja@gmail.com');

        -- Insertar roles para el usuario
        INSERT INTO worker_roles (worker_id, rol)
        SELECT w.worker_id, 'ADMIN'
        FROM worker w
        WHERE w.mail = 'benja@gmail.com'
        AND NOT EXISTS (SELECT 1 FROM worker_roles wr WHERE wr.worker_id = w.worker_id AND wr.rol = 'ADMIN');

        INSERT INTO worker_roles (worker_id, rol)
        SELECT w.worker_id, 'EMPLOYEE'
        FROM worker w
        WHERE w.mail = 'benja@gmail.com'
        AND NOT EXISTS (SELECT 1 FROM worker_roles wr WHERE wr.worker_id = w.worker_id AND wr.rol = 'EMPLOYEE');
    EOSQL

    echo "âœ… Todas las bases de datos han sido creadas exitosamente"
